---
layout: post
title: AlmaLinux 9.1で自分用のストレージサーバを構築する（KVMホスト編）
tags: Tech 自宅鯖
---

## 構想

自分用のストレージサービス + Evernote 的なメモアプリを動作させる自宅鯖を構築したい。

- サーバ用マシン（以下: 鯖機）は旧メイン PC である DELL XPS8700 を再利用する。
- KVM ホストの OS は AlmaLinux 9.1。
- VM ゲストを 1 つ作成し`Nextcloud`と`Joplin`をインストールする。OS はホストと同じく AlmaLinux 9.1。
- Nextcloud 用のストレージは HDD4 個でソフトウェア RAID を構築してそれを利用する。
- `Cloudflare Tunnel`を利用して外部にサービスを公開する。
- 可能な限りセキュリティを意識してみる。

## やったこと

### 1. Linux のインストール

インストール手順は他でさんざん紹介されてるので省略。  
こだわりポイント（？）: SOFTWARE SELECTION では `Minimal Install` を選択してあとから必要なものをインストールする方法を取る。

### 2. パッケージ更新＆最低限必要なものをインストール

```shell
dnf upgrade
dnf install vim rsync mlocate
```

### 3. SSH でログインできるようにする。

セキュリティを意識して公開鍵を利用した SSH でのみ鯖機にログインできるようにする。

クライアント側で公開鍵を作成する。  
鍵の暗号化アルゴリズムに`Ed25519`を使う。  
ssh-keygen のデフォルト暗号化アルゴリズムである`RSA`よりセキュリティに優れているらしい。

```powershell
ssh-keygen -t ed25519
```

公開鍵をホスト側に送る。  
USB メモリに作成した公開鍵を入れてホスト側でマウントして受け取る。  
公開鍵は`~/.ssh/`に`authorized_keys`という名前で配置する。

ホスト側で SSH 接続のための設定を行う。  
`/etc/ssh/sshd_config`をエディタで開き`PubkeyAuthentication yes`のコメントアウトを外す。  
SSH デーモンを再起動する。

```shell
systemctl restart sshd
```

クライアント側から SSH での接続テストを行う。

```powershell
ssh root@192.168.10.xxx
```

### 4. History コマンドで表示されるコマンドに実行時間をつける

`~/.bashrc`をエディタで開き、以下を追加する。

```bash
HISTTIMEFORMAT='%Y-%m-%d %H:%M:%S '
```

一度ログアウトしてから再度ログインし、history コマンドを実行してコマンドの実行時間が表示されていることを確認する。

```shell:実行結果
[root@host ~]# history
    1  2023-04-12 22:54:08 df -h
    2  2023-04-12 22:54:08 blkid
    ...
```

### 5. ソフトウェア RAID を構築する

RAID に使用するディスクのパーティショニングを行う。  
同様の操作を`sdc`の他に、`sdd`、`sde`、`sdf`に対しても行う。

```shell
parted -l # ディスクの一覧を表示する
parted /dev/sdc # 操作を行うディスクを選択
p # 現在の状況を確認
mklabel gpt # GNU Parted
mkpart nextcloud 0% 100% # 名前をつけてパーティショニング
p # 現在の状況を確認
```

`mdadm`をインストールする。

```shell
dnf install mdadm
```

RAID 6 を構成する。

```shell
mdadm --create /dev/md0 --level=6 --raid-devices=4 /dev/sd[cdef]1 # RAID 6を4つのHDDで構成する
cat /proc/mdstat # RAIDの状態確認
```

### 6. 仮想ブリッチを作成する

仮想ブリッチ作成。

```shell
[root@host ~]# nmcli connection add type bridge con-name bridge0 ifname bridge0 # 仮想ブリッチ作成
[root@host ~]# nmcli device status
DEVICE   TYPE      STATE                                  CONNECTION
enp2s0   ethernet  connected                              enp2s0
bridge0  bridge    connecting (getting IP configuration)  bridge0
lo       loopback  unmanaged                              --
```

仮想ブリッチに物理 NIC `enp2s0`を割り当てる。

```shell
nmcli c m enp2s0 master bridge0
```

NIC 再起動。

```shell
nmcli c down enp2s0; nmcli c up enp2s0
```

仮想ブリッチに対して適宜設定をしていく。

```shell
nmcli c m bridge0 ipv4.method manual
nmcli c m bridge0 ipv4.addresses '192.168.10.xxx/24'
nmcli c m bridge0 ipv4.gateway '192.168.10.xxx'
nmcli c m bridge0 ipv4.dns 'xxx.xxx.xxx.xxx'
nmcli c m bridge0 ipv6.method disabled
```

また、物理 NIC にはインストール時に設定したネットワーク設定が残っているため一部削除しておく。  
`ipv4.method`と`ipv4.addresses`と`ipv4.gateway`は一緒に設定を削除しないとエラーが出たので一緒に削除する。

```shell
nmcli c m enp2s0 ipv4.method disabled ipv4.addresses "" ipv4.gateway "" ipv4.dns ""
```

仮想ブリッチの起動と物理 NIC の再起動を行う。

```shell
nmcli connection up bridge0
nmcli c down enp2s0; nmcli c up enp2s0
```

疎通確認などを行い問題がないことを確認する。

### 7. KVM と cockpit をインストールして使えるようにする

KVM 動作に必要なものをインストールする。

```shell
dnf install qemu-kvm libvirt virt-install virt-viewer
```

KVM 動作に必要なデーモン`libvirtd`の起動と自動的に開始されるように設定する。

```shell
sudo systemctl start libvirtd
sudo systemctl enable libvirtd
```

cockpit をインストールする。`cockpit-machines`は cockpit で仮想マシンを扱うために必要。

```shell
dnf install cockpit cockpit-machines
```

cockpit を自動で開始するようにサービスを作成し、起動する。

```shell
systemctl start cockpit.socket
systemctl enable cockpit.socket
```

cockpit にアクセスできるようにポートを開放する。（既に解放されていれば設定の必要なし。）

```shell
firewall-cmd --list-all # ファイアウォールの設定確認 cockpit用に既にポートが解放されていれば設定の必要なし
firewall-cmd --add-service=cockpit --permanent
firewall-cmd --reload
```

色々追加したのでサービス自動起動の確認も兼ねて再起動しておく。

```shell
reboot
```

設定したサービスの起動状況の確認と、cockpit の画面にアクセスできれば OK。

※  
この時点だと libvirtd 自動起動の設定をしたにもかからわず自動で起動しなかった。  
念のため`journalctl`でログを確認したが特に問題なさそうだったのでとりあえずそのまま行く。  
予想: まだ仮想マシンを作成していないから？

```
[root@host ~]# systemctl status libvirtd
○ libvirtd.service - Virtualization daemon
     Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: disabled)
     Active: inactive (dead)
TriggeredBy: ○ libvirtd.socket
             ○ libvirtd-tcp.socket
             ○ libvirtd-admin.socket
             ○ libvirtd-tls.socket
             ○ libvirtd-ro.socket
       Docs: man:libvirtd(8)
             https://libvirt.org
```

### 8. ストレージプールの登録

VM 用のイメージファイルを置いておくディレクトリを適当に作成する。

```shell
mkdir /vhd
```

cockpit にブラウザからアクセスする。  
URL: `http://192.168.10.xxx（ホストサーバのIPアドレス）:9090`

仮想マシン > ストレージプール と進み、ストレージプールの作成ボタンを押す。  
以下の画像のように入力し、作成を押す。

![代替テキスト](/assets/img/blog/2023-04-16-01.png)

ストレージプール画面に戻るので、作成したストレージプールを有効化する。

![代替テキスト](/assets/img/blog/2023-04-16-02.png)

状態が「アクティブ」になっていれば OK。

![代替テキスト](/assets/img/blog/2023-04-16-03.png)

## 次回

次回は VM ゲストを作成し、目的のアプリを動かしていく。
